<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Filter Taxonomies within Map View</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<style>
    body { margin: 0; padding: 0; }
    #map {
        position: absolute;
        left: 25%;
        top: 0;
        bottom: 0;
        width: 75%;
    }
    .map-overlay {
        position: absolute;
        width: 25%;
        top: 0;
        bottom: 0;
        left: 0;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        background-color: #efefef;
    }
    .map-overlay input {
        display: block;
        border: none;
        width: 100%;
        border-radius: 3px;
        padding: 10px;
        margin: 0;
        box-sizing: border-box;
    }
    .map-overlay .listing {
        overflow: auto;
        max-height: 100%;
    }
    .map-overlay .listing a {
        display: block;
        padding: 5px 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        color: #404;
        text-decoration: none;
    }
    .map-overlay .listing a:last-child {
        border: none;
    }
    .map-overlay .listing a:hover {
        background: #f0f0f0;
    }
    .mapboxgl-popup-content {
        padding: 5px !important;
        scroll-behavior: auto; 
    }
    .mapboxgl-popup {
        max-width: 300px !important;
        scroll-behavior: auto;
    }
    .popup-flex-container {
        display: flex;
        flex-direction: column;
        height: 400px; /* or whatever fixed height you want */
        position: relative;
        scroll-behavior: auto;
    }

    .popup-flex-container input[type="text"] {
        flex: 0 0 auto;
        width: 100%;
        padding: 5px;
        margin-bottom: 10px;
        box-sizing: border-box;
        scroll-behavior: auto;
    }
    .popup-content-details {
        flex: 1 1 auto;
        overflow: scroll;
        height: 250px; /* or whatever value that works for you */
        scroll-behavior: auto;
    }

    .highlighted {
        background-color: yellow;
    }

    .feature-filter {
        padding: 10px;
    }

    #feature-listing {
        overflow: auto;
        max-height: calc(100% - 50px);  /* Adjusts for the height of the search input */
    }

    .custom-popup {
        max-width: 300px !important;
        /* Set a fixed height and make content scrollable */
        max-height: 500px;
        overflow-y: hidden;
        scroll-behavior: auto;
        text-align: left;
    }

    .custom-popup .your-inner-container {
        max-height: 400px;
        overflow-y: scroll;
        scroll-behavior: auto;
        text-align: left;
    }

    



</style>
</head>
<body>
<div class="map-overlay">
    <div class="feature-filter">
        <input type="text" placeholder="Click the link below for the full taxonomy report" style="width:100%; padding:5px;">
    </div>
    <div id="feature-listing" class="listing"></div>
</div>
<div id="map"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoianVuaW9yYW5hbHlzdDEiLCJhIjoiY2xranA1eHV5MHlpczNja2dieDlkZzJiciJ9.CN5Qa40PM2IMpwlyBAFTVA';
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [0, 0],
    maxZoom: 5,
    minZoom: 1,
    zoom: 2
});

const filterEl = document.getElementById('feature-filter');
const listingEl = document.getElementById('feature-listing');
function renderListings(features) {
    listingEl.innerHTML = '';
    if (features.length) {
        const listContainer = document.createElement('ul');
        for (const feature of features) {
            const listItem = document.createElement('li');
            const itemLink = document.createElement('a');
            itemLink.href = feature.properties.link;
            itemLink.target = '_blank';
            itemLink.textContent = esgTaxonomies.find(taxonomy => taxonomy.name === feature.properties.name).country;
            listItem.appendChild(itemLink);  
            listContainer.appendChild(listItem);
        }
        listingEl.appendChild(listContainer);
    }
}

function normalize(string) {
    return string.trim().toLowerCase();
}
function featureToGeoJSON(taxonomy) {
    return {
        'type': 'Feature',
        'properties': {
            'name': taxonomy.name,
            'link': taxonomy.link
        },
        'geometry': {
            'type': 'Point',
            'coordinates': [taxonomy.longitude, taxonomy.latitude]
        }
    };
}
function highlightText(content, term) {
    const highlightStartTag = "<span class='highlighted'>";
    const highlightEndTag = "</span>";
    const newText = content.replace(new RegExp(`(${term})`, 'ig'), `${highlightStartTag}$1${highlightEndTag}`);
    return newText;
}
function filterPopupContent(inputElement) {
    const searchValue = inputElement.value.toLowerCase();
    const contentDiv = inputElement.nextElementSibling;
    const textElements = contentDiv.querySelectorAll('.popup-text');
    textElements.forEach(element => {
        if (searchValue) {
            element.innerHTML = highlightText(element.textContent, searchValue);
        } else {
            element.innerHTML = element.textContent;
        }
    });
}
const esgTaxonomies = [
    {
        latitude: -6.2088,
        longitude: 106.8456,
        name: 'ASEAN Taxonomy version 1',
        link: 'https://asean.org/wp-content/uploads/2021/11/ASEAN-Taxonomy.pdf',
        issuanceyear: '2010',
        mostrecentupdate: '-',
        institution: 'ASEAN Capital Markets Forum (ACMF), the ASEAN Insurance Regulators Meeting (AIRM), the ASEAN Senior Level Committee on Financial Integration (SLC), and the ASEAN Working Committee on Capital Market Development (WC-CMD)',
        classification: 'Corporations, Financial Service providers, Investment Managers, Asset Owners (Other), Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent), Voluntary, Taxonomy',
        commentary: 'This document provides a frame for discussions with official sector and private sector stakeholders to work together on the development of the ASEAN Taxonomy. The ASEAN Taxonomy serves as a reference point to guide capital and funding towards activities that can help promote the systemic transformation needed for the region.',
        country: 'ASEAN'
    },
    {
        latitude: 23.685,
        longitude: 90.3563,
        name: 'Sustainable Finance Policy for Banks and Financial Institutions',
        link: 'http://documents1.worldbank.org/curated/en/953011593410423487/pdf/Developing-a-National-Green-Taxonomy-A-World-Bank-Guide.pdf ; https://www.bb.org.bd/mediaroom/circulars/gbcrd/dec312020sfd05.pdf',
        issuanceyear: '2017',
        mostrecentupdate: '2020',
        institution: 'Bandladesh Bank (BB)',
        classification: 'Financial Service providers, Investment Managers, Asset Owners (Other), Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent), Voluntary, Taxonomy',
        commentary: 'The policy includes Sustainable Finance Taxonomy along with a country perspective Green Taxonomy. The Green Finance and the Sustainable Linked Finance taxonomies together comprise the Sustainable Finance Taxonomy. Comprehensive lists of green products/projects/initiatives and identical areas of sustainable linked finance have been included in the policy. This policy provides clarity and guidance to identify green and Sustainable Linked Finance.',
        country: 'Bangladesh'
    },
    {
        latitude: 56.1304,
        longitude: -106.3468,
        name: 'Transition Finance Taxonomy',
        link: 'https://www.csagroup.org/news/defining-transition-finance-in-canada/',
        issuanceyear: '2019',
        mostrecentupdate: '-',
        institution: 'Government of Canada',
        classification: 'Financial Service providers, Investment Managers, Asset Owners (Other), Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent)',
        commentary: 'This taxonomy is not mandatory, and aims to be “internationally-aligned” and encompass not only green definition but a “broader mapping of transition and resiliency-linked economic activities and asset classes. Canadas major financial institutions and the Canadian Standards Association (CSA Group) are working together as part of a Taxonomy Technical Committee (TTC). The Canadian Governments Expert Panel on Sustainable Finance recommended the CSA start with the adoption of “an international green taxonomy that aligns with its global investment and trade priorities. It should then work either independently, or with other countries with similar resource endowments, to develop supplemental coverage for industry transition activities that are essential to Canada but not captured under current criteria. Canadas taxonomies should be granular enough to avoid ambiguity, while flexible enough to evolve with policy, demand and innovation”.',
        country: 'Canada'
    },
    {
        latitude: 35.8617,
        longitude: 104.1954,
        name: 'Green Bond Endorsed-Projects Catalogue',
        link: 'http://www.pbc.gov.cn/goutongjiaoliu/113456/113469/4236341/index.html',
        issuanceyear: '2015',
        mostrecentupdate: '2018',
        institution: 'Peoples Bank of China, National Development and Reform Commission, and the China Securities Regulatory Commission',
        classification: 'Others (Exchanges etc.), Corporations, Mandatory (including comply or explain), Taxonomy',
        commentary: 'This revised catalogue unifies domestic standards on green bonds and green projects. Aiming to be more aligned with international standards and Chinas carbon neutrality goal, it removes clean use of coal and other fossil energy sources and adopts a do no significant harm principle.',
        country: 'China'
    },
    {
        latitude: 30.9756,
        longitude: 112.2707,
        name: 'Green Industry Guidance Catalogue (2019 Edition)',
        link: 'https://www.ndrc.gov.cn/fggz/hjyzy/stwmjs/201903/t20190305_1220625.html',
        issuanceyear: '2019',
        mostrecentupdate: '-',
        institution: 'National Development and Reform Commission, Ministry of Industry and Information Technology, Ministry of Natural Resources, Ministry of Ecology and Environment, Ministry of Housing and Urban-Rural Development, Peoples Bank of China, National Energy Administration',
        classification: 'Corporations, Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent), Mandatory (including comply or explain), Taxonomy',
        commentary: 'The guidance is meant to enact policies to strengthen green industry development, and combine catalogue with investment, pricing, and financial policies to improve catalogue practicality. It covers 6 main industrial sectors: energy conservation and environmental protection, clean production, clean energy, ecological environment, green upgrade of infrastructure and green service. Clean coal is still in this version',
        country: 'China'
    },
    {
        latitude: 50,
        longitude: 15,
        name: 'Regulation (EU) 2020/852 (EU Taxonomy)',
        link: 'https://eur-lex.europa.eu/legal-content/EN/TXT/?toc=OJ%3AL%3A2020%3A198%3ATOC&uri=uriserv%3AOJ.L_.2020.198.01.0013.01.ENG; https://ec.europa.eu/info/business-economy-euro/banking-and-finance/sustainable-finance/eu-taxonomy-sustainable-activities_en; https://ec.europa.eu/info/publications/220202-sustainable-finance-taxonomy-complementary-climate-delegated-act_en; https://ec.europa.eu/info/files/220330-sustainable-finance-platform-finance-report-remaining-environmental-objectives-taxonomy_en',
        issuanceyear: '2020',
        mostrecentupdate: '2022',
        institution: 'European Union',
        classification: 'Corporations, Financial Service providers, Investment Managers, Asset Owners (Other), Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent), Mandatory (including comply or explain), Taxonomy, Investor ESG disclosure, Corporate ESG disclosure',
        commentary: 'This regulation lays out the framework for the EU Taxonomy, an economic activity categorisation system which will help investors, companies, issuers and project promoters navigate the transition to a low-carbon, climate resilient, environmentally sustainable and resource-efficient economy. Financial market participants offering financial products in the EU will have to disclose how they use the Taxonomy and the overall alignment of their products, which have ESG characteristics or sustainable objectives, to the Taxonomy. Companies covered by the NFRD/CSRD also have to disclose Taxonomy alignment. In December 2021, the Climate Delegated Act (determining the technical screening criteria to define how an economic activity can significantly contribute to climate change mitigation or adaptation) and Disclosure (Article 8) Delegated Act entered into law. Taxonomy disclosures began on 1 January 2021. On 2 February 2022, the Commission approved in principle a Complementary Climate Delegated Act including, under strict conditions, specific nuclear and gas energy activities in the list of economic activities covered by the EU taxonomy. This is now under scrutiny by the co-legislators. The Commissions proposal for a delegated act determining the substantial contribution technical screening criteria for the remaining 4 environmental objectives is expected in Q4 2022. The Platform on Sustainable Finance has published a report on proposing technical screening criteria for the four remaining environmental objectives. It has also published a report on taxonomy extension options for supporting a sustainable transition. It is unclear whether the Commission will decide to extend the taxonomy as described in this report.',
        country: 'EU'
    },
    {
        latitude: 47.1625,
        longitude: 19.5033,
        name: 'Social Taxonomy',
        link: 'https://ec.europa.eu/info/sites/default/files/business_economy_euro/banking_and_finance/documents/280222-sustainable-finance-platform-finance-report-social-taxonomy.pdf; https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=celex:32020R0852',
        issuanceyear: '2022',
        mostrecentupdate: '-',
        institution: 'European Union',
        classification: 'Others (Exchanges etc.), Corporations, Financial Service providers, Investment Managers, Asset Owners (Other), Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent), Mandatory (including comply or explain), Taxonomy, Investor ESG disclosure, Corporate ESG disclosure',
        commentary: 'A social taxonomy would aim to define what economic activities are aligned with social goals and direct capital flows towards such activities. Under Article 26(2)(b) of the Taxonomy Regulation, the Commission committed to publishing a report describing the provisions that would be required to extend the scope of the Taxonomy Regulation to social objectives. The Platform on Sustainable Finance, under their mandate in Article 20(2)(j), published a report which summarises the key initial observations and recommendations on this task. It is unclear when the Commission will publish their own report and how/whether a social taxonomy will be formally adopted in law.',
        country: 'EU'
    },
    {
        latitude: 0,
        longitude: -30,
        name: 'Common Ground Taxonomy - Instruction report',
        link: 'https://ec.europa.eu/info/files/international-platform-sustainable-finance-common-ground-taxonomy-report-2021_en',
        issuanceyear: '2021',
        mostrecentupdate: '-',
        institution: 'International Platform on Sustainable Finance (IPSF)',
        classification: 'Others (Exchanges etc.), Corporations, Financial Service providers, Investment Managers, Asset Owners (Other), Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent), Voluntary, Taxonomy',
        commentary: 'This report is an in-depth comparison and mapping exercise between the EU and Chinas taxonomies. It aims to provide more clarity and transparency about the commonalities and differences between approaches and potentially contribute to the analysis to lower the transboundary cost of sustainable investments and scale up the mobilization of sustainable capital internationally. It also provides a solid methodology on the basis of which other taxonomies can be compared in the future. The IPSF states that, amongst others, it may inform financial institutions in aligning their activities with low carbon economy objectives.',
        country: 'Global'
    },
    {
        latitude: 48.0196,
        longitude: 66.9237,
        name: 'Concept on introduction and development of green finance instruments and principles',
        link: 'https://gfc.aifc.kz/uploads/Concept%20on%20introduction%20and%20development%20of%20green%20finance%20instruments%20and%20principles.pdf',
        issuanceyear: '2017',
        mostrecentupdate: '-',
        institution: 'AIFC Green Finance Centre',
        classification: 'Corporations, Financial Service providers, Investment Managers, Asset Owners (Other), Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent), Voluntary, National Sustainable Finance Strategy, Taxonomy',
        commentary: 'This roadmap sets out sustainable finance ambitions - including the development of a national taxonomy.',
        country: 'Kazakhstan'
    },
    {
        latitude: 4.2105,
        longitude: 101.9758,
        name: 'Climate Change and Principle-based Taxonomy',
        link: 'https://www.bnm.gov.my/documents/20124/938039/Climate+Change+and+Principle-based+Taxonomy.pdf',
        issuanceyear: '2021',
        mostrecentupdate: '-',
        institution: 'Bank Negara Malaysia (Central Bank of Malaysia)',
        classification: 'Corporations, Financial Service providers, Investment Managers, Asset Owners (Other), Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent), Voluntary, Taxonomy',
        commentary: 'The Taxonomy sets out five Guiding Principles (GPs) intended to help financial institutions (FIs) assess and categorize economic activities according to the extent to which they meet climate objectives and promote the transition to a low-carbon economy.',
        country: 'Malaysia'
    },
    {
        latitude: 46.8625,
        longitude: 103.8467,
        name: 'Mongolia Green Taxonomy',
        link: 'https://www.greenfinanceplatform.org/policies-and-regulations/mongolia-green-taxonomy',
        issuanceyear: '2019',
        mostrecentupdate: '-',
        institution: 'Financial Stability Commission of Mongolia',
        classification: 'Corporations, Financial Service providers, Investment Managers, Asset Owners (Other), Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent), Voluntary, Taxonomy',
        commentary: 'The Mongolian green taxonomy aims to “develop a nationally agreed classification framework of activities that contribute to climate change mitigation, adaptation, pollution prevention, resource conservation, and livelihood improvement in the context of green finance”. It is designed to be applied to a wide range of financial instruments including corporate lending, consumer lending, project finance, SME finance, green bonds, equity investment, insurance, credit guarantee, grants, financial advisory and technical assistance, among others. The activities identified in this version of the taxonomy will be reviewed every 3-5 years following policy shifts, scientific developments, technological changes, and new industry needs in the green finance space. It is based on 6 principles: Contribute to national policies and targets; Address environmental challenges; Cover high-emitting, key economic sectors; Align with international standards and good practices; Comply with ESG standards; Continues review and development.',
        country: 'Mongolia'
    },
    {
        latitude: 61.524,
        longitude: 105.3188,
        name: 'Green Taxonomy',
        link: 'http://publication.pravo.gov.ru/Document/View/0001202109240043',
        issuanceyear: '2021',
        mostrecentupdate: '-',
        institution: 'Vnesheconombank (VEB)',
        classification: 'Others (Exchanges etc.), Corporations, Financial Service providers, Investment Managers, Asset Owners (Other), Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent), Voluntary, Taxonomy',
        commentary: 'The Taxonomy was developed with the ambition of compatibility with international best practice. It covers waste management, energy, construction, industry, transport, water supply, biodiversity, and agriculture. The energy criteria follow the 100g CO2e/kWh threshold, based on the recommendations of the Technical Expert Group (EU TEG) on sustainable finance for the EU Taxonomy of sustainable activities. It includes adaptation criteria and provides an opportunity to develop transition criteria in the future. However, it does not include do no significant harm criteria.',
        country: 'Russia'
    },
    {
        latitude: 1.3521,
        longitude: 103.8198,
        name: 'Green and transition taxonomy',
        link: 'https://abs.org.sg/industry-guidelines/gfit-taxonomy-public-consultation',
        issuanceyear: '2021',
        mostrecentupdate: '2022',
        institution: 'Green Finance Industry Taskforce (GFIT)',
        classification: 'Corporations, Financial Service providers, Investment Managers, Asset Owners (Other), Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent), Voluntary, Taxonomy',
        commentary: 'This draft initiative is one of four allocated to the Green Finance Industry Taskforce (GFIT), convened by the Monetary Authority of Singapore to accelerate the development of green finance: (i) develop a taxonomy (ii) enhance environmental risk management practices of financial institutions (iii) improve disclosures, and (iv) foster green finance solutions. Under the first focus area, the GFIT is exploring the development of a taxonomy for Singapore-based financial institutions, with particular relevance to those active across ASEAN. The GFIT held a consultation on their initial thinking around the potential development of a taxonomy which closed in March 2021. A second consultation paper was released on 12 May 2022, building on the broad support for the development of the Taxonomy reflected in the feedback received for the first consultation document, as well as key developments in the sustainability space. The second paper expands on the traffic light approach, and adds granularity to the application and thresholds for classification, supported by science and data.',
        country: 'Singapore'
    },
    {
        latitude: -30.5595,
        longitude: 22.9375,
        name: 'South African Green Finance Taxonomy',
        link: 'https://sustainablefinanceinitiative.org.za/taxonomy/',
        issuance: '2022',
        mostrecentupdate: '-',
        institution: 'National Treasury of the republic of South Africa with the IFC, Carbon Trust and NBI',
        classification: 'Credit Rating Agencies, Corporations, Investment Managers, Asset Owners (Other), Asset Owners (Insurance companies), Asset Owners (Corporate pension or equivalent plans), Asset Owners (non-corporate Pension Funds or equivalent), Mandatory (including comply or explain), Taxonomy, Investor ESG disclosure, Corporate ESG disclosure',
        commentary: 'This first edition of the South African Green Finance Taxonomy aims to have a range of benefits. Amongst other things, it will (i) Help the financial sector with clarity and certainty in selecting green investments in line with international best practice and South Africas national policies and priorities. (ii) Reduce financial sector risks through enhanced management of environmental and social performance. (iii) Reduce the costs associated with labelling and issuing green financial instrument. (iv) Unlock significant investment opportunities for South Africa in a broad range of green and climate-friendly assets. (v) Support regulatory and supervision oversight of the financial sector. (vi) Provide a basis for regulators to align or reference green financial products.',
        country: 'South Africa'
    }
    // Add more taxonomies here
];

function featureToGeoJSON(taxonomy) {
    return {
        'type': 'Feature',
        'properties': {
            'name': taxonomy.name,
            'link': taxonomy.link
        },
        'geometry': {
            'type': 'Point',
            'coordinates': [taxonomy.longitude, taxonomy.latitude]
        }
    };
}
// ... (other code)

const popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: true,
    className: 'custom-popup' // Add this class
});

map.on('click', 'taxonomy-markers', (e) => {
    const taxonomyName = e.features[0].properties.name;
    const taxonomy = esgTaxonomies.find(item => item.name === taxonomyName);
    if (taxonomy) {
        const popupContent = document.createElement('div');
        popupContent.innerHTML = `
            <div class="popup-flex-container">
                <input type="text" onkeyup="filterPopupContent(this)" placeholder="Search...">
                <div class="popup-content-details">
                    <strong>Country:</strong> <span class="popup-text">${taxonomy.country}</span><br><br>
                    <strong>Name:</strong> <span class="popup-text">${taxonomy.name}</span><br><br>
                    <strong>Issuance Year:</strong> <span class="popup-text">${taxonomy.issuanceyear}</span><br><br>
                    <strong>Most Recent Update:</strong> <span class="popup-text">${taxonomy.mostrecentupdate}</span><br><br>
                    <strong>Institution:</strong> <span class="popup-text">${taxonomy.institution}</span><br><br>
                    <strong>Classification:</strong> <span class="popup-text">${taxonomy.classification}</span><br><br>
                    <strong>Commentary:</strong> <span class="popup-text">${taxonomy.commentary ? taxonomy.commentary : 'N/A'}</span><br>
                </div>
            </div>
        `;

        popup.setLngLat(e.lngLat)
            .setDOMContent(popupContent)
            .addTo(map);
        e.preventDefault();  // This will prevent the map click event from firing

        setTimeout(() => {
            popupContent.scrollTop = 0;
        }, 100);

    }
});

map.on('load', () => {
    map.addSource('esgTaxonomies', {
        'type': 'geojson',
        'data': {
            'type': 'FeatureCollection',
            'features': esgTaxonomies.map(taxonomy => featureToGeoJSON(taxonomy))
        }
    });
    map.addLayer({
        'id': 'taxonomy-markers',
        'type': 'circle',
        'source': 'esgTaxonomies',
        'paint': {
            'circle-color': 'green',
            'circle-radius': 10,
            'circle-stroke-width': 2,
            'circle-stroke-color': 'white'
        }
    });
    
    // Only keep one definition of filterPopupContent function
    function filterPopupContent(inputElement) {
        const searchValue = inputElement.value.toLowerCase();
        const contentDiv = inputElement.nextElementSibling;
        const textElements = contentDiv.querySelectorAll('.popup-text');
        textElements.forEach(element => {
            if (searchValue) {
                element.innerHTML = highlightText(element.textContent, searchValue);
            } else {
                element.innerHTML = element.textContent;
            }
        });
    }
    
    map.on('movestart', () => {
        map.setFilter('taxonomy-markers', ['has', 'name', false]);
    });
    map.on('moveend', () => {
        const features = map.queryRenderedFeatures({ layers: ['taxonomy-markers'] });
        if (features) {
            renderListings(features);
        }
    });
});
</script>
