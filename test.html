<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Filter Taxonomies within Map View</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<style>
    body { margin: 0; padding: 0; }
    #map {
        position: absolute;
        left: 25%;
        top: 0;
        bottom: 0;
        width: 75%;
    }
    .map-overlay {
        position: absolute;
        width: 25%;
        top: 0;
        bottom: 0;
        left: 0;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        background-color: #efefef;
        max-height: 100%;
        overflow: hidden;
    }

    .map-overlay fieldset {
        display: none;
        background: #ddd;
        border: none;
        padding: 10px;
        margin: 0;
    }

    .map-overlay input {
        display: block;
        border: none;
        width: 100%;
        border-radius: 3px;
        padding: 10px;
        margin: 0;
        box-sizing: border-box;
    }

    .map-overlay .listing {
        overflow: auto;
        max-height: 100%;
    }

    .map-overlay .listing > * {
        display: block;
        padding: 5px 10px;
        margin: 0;
    }

    .map-overlay .listing a {
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        color: #404;
        text-decoration: none;
    }

    .map-overlay .listing a:last-child {
        border: none;
    }

    .map-overlay .listing a:hover {
        background: #f0f0f0;
    }

    .taxonomy-marker {
        width: 16px;
        height: 16px;
        background-color: green;
        border-radius: 50%;
        border: 2px solid white;
        cursor: pointer;
    }

    .map-overlay select {
        display: block;
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 3px;
    }

    .popup-heading {
        margin-bottom: 50px;
    }

    .highlighted {
        background-color: yellow;
    }

</style>
</head>
<body>

<div id="map"></div>

<div class="feature-filter">
    <input type="text" onkeyup="filterFeatureList(this)" placeholder="Search countries..." style="width:100%; padding:5px;">
</div>
<div id="feature-listing"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoianVuaW9yYW5hbHlzdDEiLCJhIjoiY2xranA1eHV5MHlpczNja2dieDlkZzJiciJ9.CN5Qa40PM2IMpwlyBAFTVA';

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-98, 38.88],
    maxZoom: 5,
    minZoom: 1,
    zoom: 3
});

const filterEl = document.getElementById('feature-filter');
const listingEl = document.getElementById('feature-listing');
const categoryFilterEl = document.getElementById('category-filter');

function renderListings(features) {
    listingEl.innerHTML = '';
    if (features.length) {
        for (const feature of features) {
            const itemLink = document.createElement('a');
            itemLink.href = feature.properties.link;
            itemLink.target = '_blank';
            itemLink.textContent = esgTaxonomies.find(taxonomy => taxonomy.name === feature.properties.name).country;  // Change to display country
            itemLink.addEventListener('mouseover', () => {
                const taxonomy = esgTaxonomies.find(item => item.name === feature.properties.name);
                if (taxonomy) {
                    const popupContent = document.createElement('div');
                    const strongElement = document.createElement('strong');
                    strongElement.textContent = feature.properties.name;
                    strongElement.classList.add('popup-heading');
                    popupContent.appendChild(strongElement);
                    popupContent.appendChild(document.createElement('br'));
                    popupContent.appendChild(document.createElement('hr'));
                    const categoryTitle = document.createElement('strong');
                    categoryTitle.textContent = 'Category: ';
                    popupContent.appendChild(categoryTitle);
                    popupContent.appendChild(document.createTextNode(taxonomy.category));
                    popupContent.appendChild(document.createElement('br'));
                    const commentaryTitle = document.createElement('strong');
                    commentaryTitle.textContent = 'Commentary: ';
                    popupContent.appendChild(commentaryTitle);
                    popupContent.appendChild(document.createTextNode(taxonomy.commentary));
                    popup.setLngLat([taxonomy.longitude, taxonomy.latitude])
                        .setDOMContent(popupContent)
                        .addTo(map);
                }
            });

            listingEl.appendChild(itemLink);
        }
        
        const filteredCountries = new Set(features.map(feature => esgTaxonomies.find(taxonomy => taxonomy.name === feature.properties.name).country));
        categoryFilterEl.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'All Countries';
        categoryFilterEl.appendChild(allOption);
        for (const country of filteredCountries) {
            const option = document.createElement('option');
            option.value = country;
            option.textContent = country;
            categoryFilterEl.appendChild(option);
        }
        filterEl.parentNode.style.display = 'block';
    }
}

function normalize(string) {
    return string.trim().toLowerCase();
}

function featureToGeoJSON(taxonomy) {
    return {
        'type': 'Feature',
        'properties': {
            'name': taxonomy.name,
            'link': taxonomy.link
        },
        'geometry': {
            'type': 'Point',
            'coordinates': [taxonomy.longitude, taxonomy.latitude]
        }
    };
}

function highlightText(content, term) {
    const highlightStartTag = "<span class='highlighted'>";
    const highlightEndTag = "</span>";
    const newText = content.replace(new RegExp(`(${term})`, 'ig'), `${highlightStartTag}$1${highlightEndTag}`);
    return newText;
}

function filterPopupContent(inputElement) {
    const searchValue = inputElement.value.toLowerCase();
    const contentDiv = inputElement.nextElementSibling;
    const textElements = contentDiv.querySelectorAll('.popup-text');

    textElements.forEach(element => {
        if (searchValue) {
            element.innerHTML = highlightText(element.textContent, searchValue);
        } else {
            // Remove all highlighting if searchValue is empty
            element.innerHTML = element.textContent;
        }
    });
}

const esgTaxonomies = [
    {
        latitude: 25,
        longitude: 104,
        name: 'ASEAN Taxonomy version 1',
        link: 'https://asean.org/wp-content/uploads/2021/11/ASEAN-Taxonomy.pdf',
        year: '2010',
        commentary: 'Policy',
        country: 'China'

    },
    {
        latitude: 23.685,
        longitude: 90.3563,
        name: 'Sustainable Finance Policy for Banks and Financial Institutions',
        link: 'http://documents1.worldbank.org/curated/en/953011593410423487/pdf/Developing-a-National-Green-Taxonomy-A-World-Bank-Guide.pdf',
        year: '2017',
        commentary: 'The policy includes Sustainable Finance Taxonomy along with a country perspective Green Taxonomy. The Green Finance and the Sustainable Linked Finance taxonomies together comprise the Sustainable Finance Taxonomy. Comprehensive lists of green products/projects/initiatives and identical areas of sustainable linked finance have been included in the policy. This policy provides clarity and guidance to identify green and Sustainable Linked Finance.',
        country: 'Bangladesh'
    },
    {
        latitude: 56.1304,
        longitude: -106.3468,
        name: 'Transition Finance Taxonomy',
        link: 'https://publications.gc.ca/collections/collection_2019/eccc/En4-350-2-2019-eng.pdf',
        year: '2013',
        commentary: 'Policy',
        country: 'Canada'
    },
    {
        latitude: 35.8617,
        longitude: 104.1954,
        name: 'Green Bond Endorsed-Projects Catalogue',
        link: 'http://www.pbc.gov.cn/goutongjiaoliu/113456/113469/4236341/index.html',
        year: '2018',
        commentary: 'Policy',
        country: 'China'
    },
    {
        latitude: 30.9756,
        longitude: 112.2707,
        name: 'Green Industry Guidance Catalogue (2019 Edition)',
        link: 'https://www.ndrc.gov.cn/fggz/hjyzy/stwmjs/201903/t20190305_1220625.html',
        year: '2022',
        commentary: 'Policy',
        country: 'China'
    },
    {
        latitude: 50,
        longitude: 15,
        name: 'Regulation (EU) 2020/852 (EU Taxonomy)',
        link: 'https://eur-lex.europa.eu/legal-content/EN/TXT/?toc=OJ%3AL%3A2020%3A198%3ATOC&uri=uriserv%3AOJ.L_.2020.198.01.0013.01.ENG',
        year: '2021',
        commentary: 'Policy',
        country: 'EU'
    },
    {
        latitude: 47.1625,
        longitude: 19.5033,
        name: 'Social Taxonomy',
        link: 'https://ec.europa.eu/info/sites/default/files/business_economy_euro/banking_and_finance/documents/280222-sustainable-finance-platform-finance-report-social-taxonomy.pdf',
        year: '2019',
        commentary: 'Policy',
        country: 'EU'
    },
    {
        latitude: 17.385044,
        longitude: 78.486671,
        name: 'Common Ground Taxonomy - Instruction report',
        link: 'https://ec.europa.eu/info/files/international-platform-sustainable-finance-common-ground-taxonomy-report-2021_en',
        year: '2016',
        commentary: 'Policy',
        country: 'EU'
    },
    {
        latitude: 48.0196,
        longitude: 66.9237,
        name: 'Concept on introduction and development of green finance instruments and principles',
        link: 'https://gfc.aifc.kz/uploads/Concept%20on%20introduction%20and%20development%20of%20green%20finance%20instruments%20and%20principles.pdf',
        year: '2014',
        commentary: 'Policy',
        country: 'Kazakhstan'
    },
    {
        latitude: 4.2105,
        longitude: 101.9758,
        name: 'Climate Change and Principle-based Taxonomy',
        link: 'https://www.bnm.gov.my/documents/20124/938039/Climate+Change+and+Principle-based+Taxonomy.pdf',
        year: '2022',
        commentary: 'Policy',
        country: 'Malaysia'
    },
    {
        latitude: 46.8625,
        longitude: 103.8467,
        name: 'Mongolia Green Taxonomy',
        link: 'https://www.greenfinanceplatform.org/policies-and-regulations/mongolia-green-taxonomy',
        year: '2015',
        commentary: 'Policy',
        country: 'Mongolia'
    },
    {
        latitude: 61.524,
        longitude: 105.3188,
        name: 'Green Taxonomy',
        link: 'http://publication.pravo.gov.ru/Document/View/0001202109240043',
        year: '2018',
        commentary: 'Policy',
        country: 'Russia'
    },
    {
        latitude: 1.3521,
        longitude: 103.8198,
        name: 'Green and transition taxonomy',
        link: 'https://abs.org.sg/industry-guidelines/gfit-taxonomy-public-consultation',
        year: '2023',
        commentary: 'Policy',
        country: 'Singapore'
    },
    {
        latitude: -30.5595,
        longitude: 22.9375,
        name: 'South African Green Finance Taxonomy',
        link: 'https://sustainablefinanceinitiative.org.za/taxonomy/',
        year: '2020',
        commentary: 'Policy',
        country: 'South Africa'
    }
    // Add more taxonomies here
];

const popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: true
});

map.on('click', 'taxonomy-markers', (e) => {
    const taxonomyName = e.features[0].properties.name;
    const taxonomy = esgTaxonomies.find(item => item.name === taxonomyName);
    if (taxonomy) {
        const popupContent = document.createElement('div');
        const strongElement = document.createElement('strong');
        strongElement.textContent = taxonomyName;
        strongElement.classList.add('popup-heading');
        popupContent.appendChild(strongElement);
        popupContent.appendChild(document.createElement('br'));
        popupContent.appendChild(document.createElement('hr'));
        const categoryTitle = document.createElement('strong');
        categoryTitle.textContent = 'Category: ';
        popupContent.appendChild(categoryTitle);
        popupContent.appendChild(document.createTextNode(taxonomy.category));
        popupContent.appendChild(document.createElement('br'));
        const commentaryTitle = document.createElement('strong');
        commentaryTitle.textContent = 'Commentary: ';
        popupContent.appendChild(commentaryTitle);
        popupContent.appendChild(document.createTextNode(taxonomy.commentary));

        popup.setLngLat(e.lngLat)
            .setDOMContent(popupContent)
            .addTo(map);
    }
});

map.on('click', () => {
    popup.remove();
});

map.on('load', () => {
    map.addSource('esgTaxonomies', {
        'type': 'geojson',
        'data': {
            'type': 'FeatureCollection',
            'features': esgTaxonomies.map(taxonomy => featureToGeoJSON(taxonomy))
        }
    });

    map.addLayer({
        'id': 'taxonomy-markers',
        'type': 'circle',
        'source': 'esgTaxonomies',
        'paint': {
            'circle-color': 'green',
            'circle-radius': 10,
            'circle-stroke-width': 2,
            'circle-stroke-color': 'white'
        }
    });

    function filterPopupContent(inputElement) {
        const searchValue = inputElement.value.toLowerCase();
        const contentDiv = inputElement.nextElementSibling;
        const textElements = contentDiv.querySelectorAll('.popup-text');
    
        textElements.forEach(element => {
            if (element.textContent.toLowerCase().includes(searchValue)) {
                element.parentElement.style.display = '';
            } else {
                element.parentElement.style.display = 'none';
            }
        });
    }

    function highlightText(content, term) {
        const highlightStartTag = "<span class='highlighted'>";
        const highlightEndTag = "</span>";
        const newText = content.replace(new RegExp(`(${term})`, 'ig'), `${highlightStartTag}$1${highlightEndTag}`);
        return newText;
    }

    function filterPopupContent(inputElement) {
        const searchValue = inputElement.value.toLowerCase();
        const contentDiv = inputElement.nextElementSibling;
        const textElements = contentDiv.querySelectorAll('.popup-text');

        textElements.forEach(element => {
            if (searchValue) {
                element.innerHTML = highlightText(element.textContent, searchValue);
            } else {
                // Remove all highlighting if searchValue is empty
                element.innerHTML = element.textContent;
            }
        });
    }

    esgTaxonomies.forEach(taxonomy => {
        new mapboxgl.Popup({
            closeOnClick: false,
            closeButton: false,
            offset: [0, -15]
        })
        .setLngLat([taxonomy.longitude, taxonomy.latitude])
        .setHTML(`
            <input type="text" onkeyup="filterPopupContent(this)" placeholder="Search..." style="width:100%; padding:5px; margin-bottom:10px;">
            <div class="popup-content">
                <strong>${taxonomy.country}</strong><br>
                <u>Name:</u> <span class="popup-text">${taxonomy.name}</span><br>
                <u>Year:</u> <span class="popup-text">${taxonomy.year}</span><br>
                <u>Commentary:</u> <span class="popup-text">${taxonomy.commentary ? taxonomy.commentary : 'N/A'}</span>
            </div>
        `)
        .addTo(map);
    });

    map.on('movestart', () => {
        map.setFilter('taxonomy-markers', ['has', 'name', false]);
    });

    map.on('moveend', () => {
        const features = map.queryRenderedFeatures({ layers: ['taxonomy-markers'] });
        if (features) {
            renderListings(features);
        }
    });
});

</script>