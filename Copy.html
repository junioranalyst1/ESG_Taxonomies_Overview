<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Filter Taxonomies within Map View</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<style>
    body { margin: 0; padding: 0; }
    #map {
        position: absolute;
        left: 25%;
        top: 0;
        bottom: 0;
        width: 75%;
    }
    .map-overlay {
        position: absolute;
        width: 25%;
        top: 0;
        bottom: 0;
        left: 0;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        background-color: #efefef;
    }
    .map-overlay input {
        display: block;
        border: none;
        width: 100%;
        border-radius: 3px;
        padding: 10px;
        margin: 0;
        box-sizing: border-box;
    }
    .map-overlay .listing {
        overflow: auto;
        max-height: 100%;
    }
    .map-overlay .listing a {
        display: block;
        padding: 5px 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        color: #404;
        text-decoration: none;
    }
    .map-overlay .listing a:last-child {
        border: none;
    }
    .map-overlay .listing a:hover {
        background: #f0f0f0;
    }
    .mapboxgl-popup-content {
        padding: 5px !important;
        scroll-behavior: auto; 
    }
    .mapboxgl-popup {
        max-width: 300px !important;
        scroll-behavior: auto;
    }
    .popup-flex-container {
        display: flex;
        flex-direction: column;
        height: 400px; /* or whatever fixed height you want */
        position: relative;
        scroll-behavior: auto;
    }

    .popup-flex-container input[type="text"] {
        flex: 0 0 auto;
        width: 100%;
        padding: 5px;
        margin-bottom: 10px;
        box-sizing: border-box;
        scroll-behavior: auto;
    }
    .popup-content-details {
        flex: 1 1 auto;
        overflow: scroll;
        height: 250px; /* or whatever value that works for you */
        scroll-behavior: auto;
    }

    .highlighted {
        background-color: yellow;
    }

    .feature-filter {
        padding: 10px;
    }

    #feature-listing {
        overflow: auto;
        max-height: calc(100% - 50px);  /* Adjusts for the height of the search input */
    }

    .custom-popup {
        max-width: 300px !important;
        /* Set a fixed height and make content scrollable */
        max-height: 500px;
        overflow-y: hidden;
        scroll-behavior: auto;
        text-align: left;
    }

    .custom-popup .your-inner-container {
        max-height: 400px;
        overflow-y: scroll;
        scroll-behavior: auto;
        text-align: left;
    }

    .collapsible {
        margin-bottom: 5px;
    }

    .collapsible-header {
        cursor: pointer;
        padding: 10px;
        border: 1px solid #ddd;
        font-weight: bold;
    }

    .collapsible-content {
        padding: 0 10px;
        display: none;
        overflow: hidden;
        border: 1px solid #ddd;
        border-top: none;
    }

    .collapsible-arrow {
        float: right;
    }

</style>
</head>
<body>
<div class="map-overlay">
    <div class="feature-filter">
        <input type="text" placeholder="Click the link below for the full taxonomy report" style="width:100%; padding:5px;">
    </div>
    <div id="feature-listing" class="listing"></div>
</div>
<div id="map"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoianVuaW9yYW5hbHlzdDEiLCJhIjoiY2xranA1eHV5MHlpczNja2dieDlkZzJiciJ9.CN5Qa40PM2IMpwlyBAFTVA';
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [0, 0],
    maxZoom: 5,
    minZoom: 1,
    zoom: 2
});

const filterEl = document.getElementById('feature-filter');
const listingEl = document.getElementById('feature-listing');
function renderListings(features) {
    listingEl.innerHTML = '';
    if (features.length) {
        const listContainer = document.createElement('ul');
        for (const feature of features) {
            const listItem = document.createElement('li');
            const itemLink = document.createElement('a');
            itemLink.href = feature.properties.link;
            itemLink.target = '_blank';
            itemLink.textContent = esgTaxonomies.find(taxonomy => taxonomy.name === feature.properties.name).country;
            listItem.appendChild(itemLink);  
            listContainer.appendChild(listItem);
        }
        listingEl.appendChild(listContainer);
    }
}

function normalize(string) {
    return string.trim().toLowerCase();
}
function featureToGeoJSON(taxonomy) {
    return {
        'type': 'Feature',
        'properties': {
            'name': taxonomy.name,
            'link': taxonomy.link
        },
        'geometry': {
            'type': 'Point',
            'coordinates': [taxonomy.longitude, taxonomy.latitude]
        }
    };
}
function highlightText(content, term) {
    const highlightStartTag = "<span class='highlighted'>";
    const highlightEndTag = "</span>";
    const newText = content.replace(new RegExp(`(${term})`, 'ig'), `${highlightStartTag}$1${highlightEndTag}`);
    return newText;
}
function filterPopupContent(inputElement) {
    const searchValue = inputElement.value.toLowerCase();
    const contentDiv = inputElement.nextElementSibling;
    const textElements = contentDiv.querySelectorAll('.popup-text');
    textElements.forEach(element => {
        if (searchValue) {
            element.innerHTML = highlightText(element.textContent, searchValue);
        } else {
            element.innerHTML = element.textContent;
        }
    });
}
const esgTaxonomies = [
    {
        latitude: 56.1304,
        longitude: -106.3468,
        name: 'Transition Finance Taxonomy',
        link: 'https://www.csagroup.org/news/defining-transition-finance-in-canada/',
        yearinitiated: '2019',
        mostrecentupdate: 'This taxonomy aims to be “internationally-aligned” ie, can operate independently or be compatible with other international taxonomies that cover areas not covered. The EU taxonomy was a jumping off point for its creation.  It encompasses not only a green definition but a “broader mapping of transition and resiliency-linked economic activities and asset classes. It was intended to be ‘granular enough to avoid ambiguity, while flexible enough to evolve with policy, demand and innovation”. <br> <br> It is intended to work either independently, or with other countries with similar resource endowments, to develop supplemental coverage for industry transition activities that are essential to Canada but not captured under current criteria. <br> <br>Phase 1 would see the SFAC publishing a short-form taxonomy covering priority sectors and activities by mid-2023 (this deadline appears to have been missed), as well as laying the groundwork for the implementation of the taxonomy for the long term, including governance, funding and strategic planning. Phase 2 would involve the full implementation of the Taxonomy initiative and publishing a substantially more complete and detailed taxonomy by end-2025 at the latest.',
        mandatedinlaworvoluntary: 'No - Due to the voluntary nature of the taxonomy, the governance model proposed does not antcipate a compliance review and enforcement function, although the report notes that its use may ultimately intersect with federal and provincials laws (e.g., issuing financial instruments under the taxonomy would be subject to provincial securities laws that are administered by provincial securities regulators, which play a compliance and enforcement function).',
        developer: 'The journey to develop a Canadian Taxonomy has not been a linear process. <br> <br> In 2019, The Canadian Expert Panel on Sustainable Finance recommended to the Canadian Government that the creation of a market-based tool to mobilise capital to transition to a net zero greenhouse gas (GHG) emissions economy. <br> <br> Reacting to this, the Canadian financial community and eight industry sectors, including forestry, agriculture, mineral mining, utilities, steel, aluminium, cement, and energy, came together to collaborate on a foundational transition guidance document for the marketplace. The process was facilitated by CSA Group and resulted in the development of a volunteer committee on Transition and Sustainable Finance. The committee worked together over a two-year period, but there were fundamental differences of opinion among committee members, and consensus on the draft foundations document could not be achieved. The CSA Group determined that work of the committee had progressed as far as it could at that time. To determine next steps, CSA Group and the committee intend to work with the Sustainable Finance Action Council (SFAC) and government stakeholders. In May 2021, the Government of Canada launched the Sustainable Finance Action Council (SFAC) to help lead the Canadian financial sector towards integrating sustainable finance into standard industry practice. <br> <br> The SFAC serves as a centre of expertise, partnership, and dialogue on sustainable finance issues in Canada and internationally. It will also help champion the implementation of sustainable finance best practices across the Canadian financial sector and the broader Canadian economy, and support the growth of a well-functioning sustainable finance market in Canada. This will help accelerate movement of private capital in support of the Government of Canada’s climate goals, in particular: <br> <br> • to support the achievement of Canada’s enhanced 2030 target; <br> • to transition to a net-zero emissions economy by 2050; and, <br> • to ensure climate resilience and adaptation throughout Canada. <br> <br> The council’s early emphasis was to focus on enhancing climate-related financial disclosures in Canada’s private and public sector, aligned with the recommendations of the Task Force on Climate-Related Financial Disclosures. The Council also decided to prioritise gender and diversity reporting in a first instance. <br> <br> Three technical expert groups and one working group support the work of the SFAC and are comprised of SFAC organizations as core members, with expertise from industry, academia, civil society, and government incorporated to support progress on workplans. Of the four groups, the taxonomy working group (Lead: Barb Zvan, UPP Investments) was established to outline needs amongst market participants to define green and transition investments and activities within the context of Canada’s capital markets. <br> <br> At the same time as these efforts began, the CSA Group engaged Climate Bonds Initiative to explore the characteristics and approaches of international taxonomies within the Canadian context. It included a review of international taxonomies, focusing on their approaches toward low-carbon transition, along with the application of these approaches to the Canadian economic context. Through this exploration, the challenges and opportunities for the development of a Canadian taxonomy were identified. <br> <br> The report went on to propose and are presented recommendations that could inform a future Canadian transition taxonomy. <br> <br> The future governance proposed consists of a three-tier model: <br> <br> 1. A high-level body that is accountable for the initiative and provides strategic direction and oversight (Tier one); <br> <br> 2.	A technical custodian body with expert and technical staff that develops the standards and technical criteria (Tier two); and <br> <br> 3. Technical advisory groups comprising independent external experts that support the technical work of custodians, as well as forums and due process initiatives to obtain stakeholder feedback on consultation drafts (Tier three).',
        objective: 'The report suggests the objectives should be as follows: <br> <br> • Prioritise climate mitigation but position the initiative to move quickly into other critical areas, such as climate adaptation and resilience <br> <br> • Develop a versatile taxonomy that can support classifying climate-related financial instruments (e.g., bonds, loans)—as well as other private and public sector use cases <br> <br> • Require issuing companies to commit to issuing net-zero plans, targets and climate disclosure, to ensure the taxonomy is supporting credible transitions <br> <br> • Foster rigorous, scientific-based screening criteria that are reviewed regularly to reflect innovation and climate science <br> <br> • Promote interoperability with major science-based taxonomies globally to foster market confidence and reduce market fragmentation',
        linkpolicyobjectives: 'Paris Agreement: Yes <br> Regional Framework: - <br> National Strategies: Yes',
        sectorscovered: 'Not confirmed at this stage (January 2024) <br> <br> The report suggests that in addition to regular reviews, the developers of the taxonomy should consider the merits of a mechanism that would allow for the review of material ad hoc requests from market participants to scope in one-off activities, projects and assets for inclusion in the taxonomy. As it is difficult to set criteria that would cover all intended green and transition activities, a review mechanism would provide discretion to grant ad hoc requests, in keeping with the climate objectives and climate science of the taxonomy.',
        approachtoeligibility: 'principle-based: YES - The criteria can be set by relying on high-level principles, lists of approved activities, technical screening criteria or a combination. <br> Pass-list approach: - <br> Threshold and criteria: YES <br> Umbrella clauses: TBC <br> Any combination of the above: YES',
        basedonanothertaxonomy: 'YES',
        Intendedtobeinteroperable: 'YES',
        Purpose: 'Green: focus on identifying eligible - YES <br> Transition: supports transition of all existing assets - YES - The criteria and thresholds should require the reporting of standardized metrics and qualitative information, which would establish clear data requirements and support the intra- and inter- industry comparability of taxonomy alignment and post-issuance reporting. <br> Ineligible investments - YES - The criteria can be set by relying on high-level principles, lists of approved activities, technical screening criteria or a combination. The criteria can either be static or dynamic. Dynamic criteria are subject to a regular review process, where the criteria are made more stringent over time to reflect technological advancement and the need for increasing ambition as climate targets draw closer. The report provides an overview of a green and transition finance taxonomy with dynamic criteria. <br> <br> Taken together, the criteria are meant to support a theory of economy-wide change aimed at rapidly expanding green activities, decarbonizing higher-emitting sectors where possible and moving away from economic activities that are inconsistent with global climate objectives and carry significant transition risk. <br> <br> Designing a practical and credible taxonomy for Canada requires drawing boundaries around the types of activities that are consistent with 1.5 °C emissions pathways. These boundaries are important for oil and gas activities given their emissions profile, and they need to be analysed separately, but calibrating them appropriately is a complex undertaking that will require significant technical work and industry engagement in future implementation phases. <br> <br> To be categorized as transition, existing oil and gas projects would need to demonstrate improvements to their emissions intensity by 2030. Eligible projects would therefore need to demonstrate that current and future capital expenditures put them on a track to reduce their emissions intensity such that it complies with the 2030 threshold established via net-zero modeling. Eligible projects would also need to have lifespans that are proportionate to global demand scenarios in representative 1.5°C pathways (recognizing that the runway for gas is likely longer than for oil). Existing oil and gas extraction projects would also need to demonstrate that making the new investment to reduce emissions will not increase the lifespan of their operations',
        Sectorclassification: '-',
        DonosignificantharmDNHS: 'YES',
        Socialobjectivessafeguards: 'Limited reference. The governance includes the need to involve indigenous groups.',
        Additionalguidance: 'https://www.canada.ca/en/department-finance/programs/financial-sector-policy/sustainable-finance/sustainable-finance-action-council/taxonomy-roadmap-report.html',
        otherusefuldocuments: '• CE 28, 2020 - Green Bonds <br> • CE 08, 2021 - ESG Integration for Voluntary Pension Funds <br> • CE 31, 2021 – ESG and Climate Disclosure Regulation for Issuers <br> • PCE 2022 - Sustainability Linked Bonds <br> <br> The following report provides a helpful comparison between the EU and Colombian Taxonomy provided by the Climate Bond Institute.',
        MemberofIPFS: 'YES <br> <br> Latest info from the IPFS: The Canadian Government is examining the advice of SFAC before decide.',
        country: 'Canada'
    },
    {
        latitude: 4.7110,
        longitude: -74.02986,
        name: 'Taxonomía Verde de Colombia',
        link: 'https://www.taxonomiaverde.gov.co/webcenter/portal/TaxonomaVerde',
        yearinitiated: '13 April 2022',
        mostrecentupdate: '-',
        mandatedinlaworvoluntary: 'The taxonomy is voluntary and has no legal status.  However, there are regulations in place to support its implementation, although these do not impose specific disclosure obligations.  The SFC has issued external circulars (or rules0 that encourage the use of the taxonomy in labelling of green bonds, ESG portfolio labelling and voluntary labelling of pension fund). SFC’s Centro de Estudios Regulatorios (cerlatam.com)',
        developer: 'Developed by the Government institutions – The Colombian Superintendency of Finance (SFC), the Ministry of finance (MHCP), The National Planning Department (DNP), the Department of Statistics of Colombia (DANE) and the Ministry of Environment and Sustainable Development (MADS) oversaw the taxonomy development process.',
        objective: 'The Colombian Green Taxonomy defined a set of 5 principles that will guide further development and updates. The main objective is to make a substantial contribute to climate change mitigation (1), followed by climate change adaptation (2), ecosystem and (3) biodiversity conservation and water management, soil management, (4) circular economy and  pollution prevention and control.  This is broadly similar to the EU taxonomy (even in order of priority) although slightly different wording is used however, soil management is specifically singled out in the Colombian taxonomy which is not the case in the EU taxonomy and comes before the circular economy and pollution prevention and control. <br> In the sectors and activities selected, the taxonomy must also comply with the assessment of DNSH to other environmental including adaptation objectives, as well as ensure compliance with the minimum safeguard requirements. <br> 6 principles will guide the SFC’s updates. <br> Principle 1 – align with high-level environmental goals and priorities for Colombia <br> Principle 2 – define eligibility criteria and compliance requirements for each asset and/or activity. <br> Principle 3 – include environmental laws, norms, regulations, plans and programs. <br> Principle 4 – reference, when necessary practices or standards from environmental certification systems. <br> Principle 5 - align economic activities with international standard industrial codes. <br> Principle 6 – study and analyse international taxonomies, including the EU taxonomy for interoperability.',
        linkpolicyobjectives: 'Paris Agreement: Yes <br> Regional Framework: Yes (TBC) <br> National Strategies:',
        sectorscovered: 'Sectors: Construction, Energy, Transport, Water supply and treatment, Waste management emissions capture, Manufacturing, Information and communication. <br> <br> Description: The Colombian taxonomy covers 7 sectors, 47 activities/assets (excluding the AFOLU sector) and 11 further activities that derive from three land use sectors which have environmental objectives other than climate change mitigation.  On this basis, the Colombian Green Taxonomy includes ten sectors with 58 activities.  The EU taxonomy covers nine economic sectors and 94 activities and assets. However, it is important to note that the three sectors of Forestry, Agriculture and Livestock are particularly important as they contribute to 59 % of the country’s GHG emissions. Differences also arise in the fact that the Colombian Green Taxonomy consolidates some activities in some areas.',
        approachtoeligibility: 'principle-based: YES, Pass-list approach: YES, Threshold: and criteria: YES, Umbrella Clauses, Any combination of the above; <br> <br> Description: Both taxonomies also included enabling sectors that are necessary to achieve decarbonisation (e.g., activity of data-driven climate solutions under the ICT sector). Furthermore, both taxonomies address activities that have a viable transition pathway to achieve the taxonomy ambition over a defined period. These activities have a potential technological pathway for significantly improving their performance with an urgent transition to prevent and avoid negative damage, which is the case for activities in the manufacturing sector such as cement and aluminium manufacturing.',
        basedonanothertaxonomy: 'The Colombian Green Taxonomy also evaluated other taxonomies and frameworks from the EU and Climate Bonds, and compared them with the national Measurement, Reporting, and Verification (MRV) system to identify the list of sectors and activities.',
        Intendedtobeinteroperable: 'YES',
        Purpose: 'Green: focus on identifying eligible - YES <br> Transition: supports transition of all existing assets - YES <br> Ineligible investments - YES',
        Sectorclassification: 'Activities that make a substantial contribution define their eligibility based on TSC, which include qualitative or quantitative metrics and thresholds.',
        DonosignificantharmDNHS: 'YES <br> <br> Furthermore, activities must comply with the DNSH requirements for other environmental objectives defined in the taxonomies. Generic DNSH requirements for all activities and specific requirements for certain activities exist (similar to the EU). When an activity does not have specific requirements then generic DNSH requirements must be followed.',
        Socialobjectivessafeguards: 'The eligible asset must ensure that it does not generate a negative social impact. (social risks, working conditions…)',
        Additionalguidance: 'The only official regulatory framework for the adoption of the Colombian Green Taxonomy is the SFC’s External Circular 005 of 20223 which provides instructions for adoption. It allows entities supervised by the SFC the option of using the taxonomy for various purposes, including identifying financing and investment opportunities for supporting the transition to a sustainable economy, measuring portfolio alignment with green assets and activities, structuring green products and solutions, and enhancing disclosure and transparency practices. The external circular includes three annexes specifying: the use of the taxonomy for investment portfolios, green bond issuers, and voluntary pension funds.',
        otherusefuldocuments: '• CE 28, 2020 - Green Bonds <br> • CE 08, 2021 - ESG Integration for Voluntary Pension Funds <br> • CE 31, 2021 – ESG and Climate Disclosure Regulation for Issuers <br> • PCE 2022 - Sustainability Linked Bonds <br> <br> The following report provides a helpful comparison between the EU and Colombian Taxonomy provided by the Climate Bond Institute.',
        MemberofIPFS: 'NO',
        country: 'Colombia'
    },
    {
        latitude: 47.1625,
        longitude: 19.5033,
        name: 'Sustainable Finance Taxonomy',
        link: '',
        yearinitiated: '-',
        mostrecentupdate: '-',
        mandatedinlaworvoluntary: '-',
        developer: '-',
        objective: '-',
        linkpolicyobjectives: '-',
        sectorscovered: '-',
        approachtoeligibility: '-',
        basedonanothertaxonomy: '-',
        Intendedtobeinteroperable: '-',
        Purpose: '-',
        Sectorclassification: '-',
        DonosignificantharmDNHS: '-',
        Socialobjectivessafeguards: '-',
        Additionalguidance: '-',
        otherusefuldocuments: '-',
        MemberofIPFS: '-',
        country: 'EU'
    },
    // Add more taxonomies here
];

function featureToGeoJSON(taxonomy) {
    return {
        'type': 'Feature',
        'properties': {
            'name': taxonomy.name,
            'link': taxonomy.link
        },
        'geometry': {
            'type': 'Point',
            'coordinates': [taxonomy.longitude, taxonomy.latitude]
        }
    };
}
// ... (other code)

const popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: true,
    className: 'custom-popup' // Add this classf
});

map.on('click', 'taxonomy-markers', (e) => {
    const taxonomyName = e.features[0].properties.name;
    const taxonomy = esgTaxonomies.find(item => item.name === taxonomyName);
    if (taxonomy) {
        const popupContent = document.createElement('div');
        popupContent.innerHTML = `
            <div class="popup-flex-container">
                <input type="text" onkeyup="filterPopupContent(this)" placeholder="Search...">
                <div class="popup-content-details">
                    <strong>Country:</strong> <span class="popup-text">${taxonomy.country}</span><br><br>
                    <strong>Year Initiated:</strong> <span class="popup-text">${taxonomy.yearinitiated}</span><br><br>
                    <strong>Intended to be interoperable:</strong> <span class="popup-text">${taxonomy.Intendedtobeinteroperable}</span><br><br>
                    <strong>Sector Classification:</strong> <span class="popup-text">${taxonomy.Sectorclassification}</span><br><br>
                    <strong>Social objectives / safeguards:</strong> <span class="popup-text">${taxonomy.Socialobjectivessafeguards}</span><br><br>
                    <strong>Social Member of IPFS:</strong> <span class="popup-text">${taxonomy.MemberofIPFS}</span><br><br>
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>Mandated in Law or Voluntary</span>
                            <span class="collapsible-arrow">&#9660;</span>
                        </div>
                        <div class="collapsible-content">
                            <p>${taxonomy.mandatedinlaworvoluntary}</p>
                        </div>
                    </div>
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>Developer</span>
                            <span class="collapsible-arrow">&#9660;</span>
                        </div>
                        <div class="collapsible-content">
                            <p>${taxonomy.developer}</p>
                        </div>
                    </div>
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>Objective</span>
                            <span class="collapsible-arrow">&#9660;</span>
                        </div>
                        <div class="collapsible-content">
                            <p>${taxonomy.objective}</p>
                        </div>
                    </div>
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>Link Policy Objectives</span>
                            <span class="collapsible-arrow">&#9660;</span>
                        </div>
                        <div class="collapsible-content">
                            <p>${taxonomy.linkpolicyobjectives}</p>
                        </div>
                    </div>
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>Sectors Covered</span>
                            <span class="collapsible-arrow">&#9660;</span>
                        </div>
                        <div class="collapsible-content">
                            <p>${taxonomy.sectorscovered}</p>
                        </div>
                    </div>
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>Approach to Elegibility</span>
                            <span class="collapsible-arrow">&#9660;</span>
                        </div>
                        <div class="collapsible-content">
                            <p>${taxonomy.approachtoeligibility}</p>
                        </div>
                    </div>
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>Purpose</span>
                            <span class="collapsible-arrow">&#9660;</span>
                        </div>
                        <div class="collapsible-content">
                            <p>${taxonomy.Purpose}</p>
                        </div>
                    </div>
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>Do No Significant Harm (DNSH)</span>
                            <span class="collapsible-arrow">&#9660;</span>
                        </div>
                        <div class="collapsible-content">
                            <p>${taxonomy.DonosignificantharmDNHS}</p>
                        </div>
                    </div>
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>Additional guidance</span>
                            <span class="collapsible-arrow">&#9660;</span>
                        </div>
                        <div class="collapsible-content">
                            <p>${taxonomy.Additionalguidance}</p>
                        </div>
                    </div>
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>Other useful documents</span>
                            <span class="collapsible-arrow">&#9660;</span>
                        </div>
                        <div class="collapsible-content">
                            <p>${taxonomy.otherusefuldocuments}</p>
                        </div>
                    </div>
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>Most Recent Update</span>
                            <span class="collapsible-arrow">&#9660;</span>
                        </div>
                        <div class="collapsible-content">
                            <p>${taxonomy.mostrecentupdate}</p>
                        </div>
                </div>
            </div>
        `;

        popup.setLngLat(e.lngLat)
            .setDOMContent(popupContent)
            .addTo(map);
        e.preventDefault();

        setTimeout(() => {
            popupContent.scrollTop = 0;
        }, 100);

        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
                this.nextElementSibling.style.display = 
                    this.nextElementSibling.style.display === 'block' ? 'none' : 'block';
                this.querySelector('.collapsible-arrow').textContent = 
                    this.nextElementSibling.style.display === 'block' ? '▼' : '►';
            });
        });
    }
});


map.on('load', () => {
    map.addSource('esgTaxonomies', {
        'type': 'geojson',
        'data': {
            'type': 'FeatureCollection',
            'features': esgTaxonomies.map(taxonomy => featureToGeoJSON(taxonomy))
        }
    });
    map.addLayer({
        'id': 'taxonomy-markers',
        'type': 'circle',
        'source': 'esgTaxonomies',
        'paint': {
            'circle-color': 'green',
            'circle-radius': 10,
            'circle-stroke-width': 2,
            'circle-stroke-color': 'white'
        }
    });
    
    // Only keep one definition of filterPopupContent function
    function filterPopupContent(inputElement) {
        const searchValue = inputElement.value.toLowerCase();
        const contentDiv = inputElement.nextElementSibling;
        const textElements = contentDiv.querySelectorAll('.popup-text');
        textElements.forEach(element => {
            if (searchValue) {
                element.innerHTML = highlightText(element.textContent, searchValue);
            } else {
                element.innerHTML = element.textContent;
            }
        });
    }
    
    map.on('movestart', () => {
        map.setFilter('taxonomy-markers', ['has', 'name', false]);
    });
    map.on('moveend', () => {
        const features = map.queryRenderedFeatures({ layers: ['taxonomy-markers'] });
        if (features) {
            renderListings(features);
        }
    });
});
</script>
